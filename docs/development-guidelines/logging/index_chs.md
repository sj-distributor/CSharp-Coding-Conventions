---
布局: default
标题: C#
nav_order: 4
上级目录: 开发指南
子目录: 无
---

# 日志记录
日志记录最简单的方法就是在发生各种系统事件时记录有用的信息。因为日志记录对于处理多个系统问题很有用，所以这个术语很不幸被重载了，可能会有歧义。
涉及到日志记录的一些常见问题有:
- **诊断**	-验证应用程序是否按预期运行，或者确定为什么它没有运行。
- **技术分析**	-检测多余的网络呼叫，查询n+1个问题等等。
- **监控**	-在软件(例如未处理的运行时异常，过多的用户登录失败)或底层硬件(例如磁盘空间不足)中检测到异常情况时向人员发出警报。
- **商业分析**	-记录商业事件以供分析(例如，每日订单平均值分析)。
- **分析**	-测量应用程序的运行时性能和资源消耗。
- **审计**	-记录用户所做或试图做的事情，以确保安全和检测未经授权的访问。

本文档主要关注应用程序诊断和应用程序运行时异常的监视。
有各种各样的工具，它们要么专门用于某个特定的方面(例如，衡量标准的指标)，为多个关注点提供单一的管理。这些工具应该在适当的地方使用，但是请记住，即使没有额外的工具，也可以实现简单的需求。例如，可以很容易地从“生产环境”日志消息的数量中提取出简单的指标，例如每天生产的新产品数。另一个例子是，通过配置将错误的日志消息通过电子邮件发送给系统管理员，可以充分地提醒系统管理员系统问题。
在为日志设计体系结构时，首先定义将在哪里存储消息以及如何访问消息。这个决定可能会影响选择什么库来记录和分发日志消息到存储区。
- TOC
## 如何去选择日志存储

### **要** 评估项目是否会从集中的日志存储中受益
大多数单独的应用程序项目在默认情况下都有一个“集中式”存储，通过使用web服务器的文件系统或数据库。另一方面，分布式系统将需要一个“真正的”集中存储，该存储位于网络上，并从多个来源接收传输。
如果有以下情况，可以考虑使用网络集中式存储:
-该项目是一个分布式系统，将多个服务的各个日志存储之间的“发生了什么”关联起来会很痛苦。
考虑使用集中的云存储(例如Splunk, Application Insights)
-该项目将受益于基础设施监测和警报。大多数产品都提供了额外接收应用程序诊断消息的方法，为应用程序事件和基础设施性能提供了单一存储。
考虑使用本地集中存储(例如ELK)
—应用程序需要在没有网络的情况下运行。(例如制造设施)
-有人担心敏感的运营指标放在云端。(你不应该记录任何高度敏感的信息，如社会保险号、信用卡号、密码等)

### **要** 在选择日志存储时，为涉及的所有涉众进行规划
列出需要访问日志或接收通知的所有角色的列表。典型的候选人有:
-开发人员
-质量保证
-IT支持
-外部审计师
确保所有需要它的人都可以访问所选的日志接收。您可能还会发现，组应该对特定类型的条目有不同的访问权限。

### **要** 定义要记录的业务概念和指标，当有明确的值时
对未捕获的属性进行有意义的分析要困难得多。与报告类似，推动“你希望更容易知道什么?”以及“基于这些信息，你会做出什么样的决定?”

### **要** 评估预期成本
如果可能，对数据存储进行初步估计。如果产品是按流量收费的，那么在一开始这可能很难做到。一定要估计任何许可或每个节点/每个人的成本。

### **要** 分析并记录保留策略
分析需要记录和保留的任何日志数据，以满足法规遵从性。在仓储、物流和成本中考虑到这一点。
对于生成大量细粒度数据的指标，考虑在某个时间段(每个月、季度、年等)后将数据迁移到较低解释度。

### **考虑** 使用应用程序洞察力
应用程序洞察力在作为云提供商使用时，可以很好地与Microsoft框架和Azure基础设施集成。

## 如何选择日志库
### **要** 如果没有使用现有工具，则使用Serilog作为“默认”选择
[Serilog](https://serilog.net/)从头开始构建，以支持结构化日志记录，并且有许多贡献的接收器。
[NLog](https://nlog-project.org/)是另一个可靠的选择，它曾一度被Serilog(没有结构化日志记录，支持.net Core的速度较慢)所取代。这些差距大部分已经消除。今天，仍然有一个区别——Serilog支持浓缩程序，而NLog不支持。

## 如何构建日志的配置
### **要** 确保可以在不重新部署二进制文件的情况下配置日志
至少应该能够在环境中调整日志记录级别，而无需进行部署以响应详细日志记录带来的潜在性能问题。这样做意味着将日志级别外部化到配置文件中。
参见[Serilog配置](https://github.com/serilog/serilog/wiki/Configuration-Basics)，获取有关文件配置的.net完整和.net Core框架扩展的链接。
如果你使用的是ASP.NET Core，它提供了一个配置选项功能，不需要重新启动应用程序就可以应用，详细信息请参见(https://docs.microsoft.com/en-us/aspnet/core/fundamentals/configuration/options?view=aspnetcore-3.1)。

### **考虑** 使用代码进行公共配置
许多系统将具有相同的接收器类型(例如数据库、文件路径、ELK堆栈)，对于不同的环境(例如dev、prod)具有不同的实例或位置。如果在所有环境中(包括本地开发)都使用特定的接收器，请考虑在c#代码中配置该接收器，并在配置文件中只存储实例配置(连接字符串、文件路径、IP地址)。

### **考虑** 使用微软记录扩展ASP.NET Core应用程序

ASP.NET Core使用了新的日志抽象Microsoft.Logging.Extensions。使用这种抽象有两个好处:

*‘未来的考虑’ 以应对未来工具的变化
* 在您配置的接收器中,能够获取相关ASP.NET Core日志消息

## 如何添加日志消息
### **不要** 使用工具自动添加诊断和业务分析日志消息
虽然开发人员不创建日志语句可以节省少量时间，但自动生成的日志语句的实现无需考虑有用性。您的日志将是一个运行时堆栈跟踪。
注意，此指南专门用于诊断和业务分析日志记录。自动注入仪器是有用的。考虑使用可以执行注入本身的外部分析工具，以避免两步分析过程(使用一种工具进行注入，使用另一种工具进行分析)。

## 何时添加日志消息
### **要** 记录未处理的错误
对于.net客户端框架，订阅' AppDomain.UnhandledException '。
对于ASP.NET，添加一个异常过滤器。
参见[致命](/development-guidelines/logging/index.html# Fatal)和[错误](/development-guidelines/logging/index.html# Error)。

### **要** 记录您没有预料到但想知道是否发生的情况
看到[警告](/development-guidelines/logging/index.html#warn)。

### **考虑** 分析记录业务事件
通常，您应该有一个集中的日志存储，并积极地与用户协作定义这些事件。
看到[信息](/development-guidelines/logging/index.html#info)。
您拥有响应外部事件或执行定期计划任务的后端流程。这可以是一个独立的流程，也可以是分布式系统中的一个节点。

### **要** 记录复杂值计算或条件逻辑
这种复杂性可以在后端流程中隔离，也可以在UI交互中隔离。能够记录“发生了什么”以确定或验证行为是很有用的。
看到(调试)(/development-guidelines/logging/index.html#debug)。

### **不要** 记录从其他来源确定的琐碎消息
例如，不要记录可以从web服务器日志找得到的控制器动作事件。

## 日志消息中应该包含什么
### **要** 在分布式系统或复杂流程中使用关联id
关联id可用于将独立相关的消息分组在一起，以便在分析过程中方便地查看关联的消息。例如，在分布式系统中，服务A向服务B发送一个请求作为操作的一部分，包括服务A和服务B上的事件的相同的关联id，这就很容易从系统的角度查看事件链，而不必手动将来自每个服务的消息单独链接起来。
一个系统并不一定是分布式的，关联id是很有用的。例如，单个系统中的多步骤业务事务也可以从使用关联id。

## 如何选择日志消息的级别
### **要** 使用适当的日志级别

#### 致命
应用程序或服务不能继续运行，要么是自终止，要么是被操作系统终止。

#### 错误
一个操作(ASP.NET控制器动作，客户端UI按钮点击事件处理程序，定时进程，消息总线处理程序)意外失败，但应用程序或服务可以继续做其他操作。
例外——预期的验证不是错误。如果您有一个需要指定姓氏的操作，并且您的操作检测到它缺失并返回“需要姓氏”，这不是一个应该记录在错误级别的消息。(另一方面，如果您的操作目标之一是级别可用性或用户准确性，您可能会将这些记录为各种"信息"级别)

#### 警告
发生了一些非典型的情况，但操作仍然可以成功完成。
-假设不可能的情况发生了，例如“在自动调用发票验证时，所有的发票都将被批准”。人应该看看是如何发生的。
-处理了预期的问题，但重复出现可能是一个问题。
-初始调用外部系统失败，重试成功
-断路器模式无效

#### 信息
对于本地开发以外的环境，这通常是默认级别。"信息"消息的量可以代表生产环境中的大量信息，但是在生产环境中启用"信息"级别不应引起对性能或接收容量的重大影响。
**普通**
-应用或服务启动事件和配置
-应用或服务关闭事件
-更改应用程序或服务的一般配置

**业务**
只有在使用集中式存储并与业务一起识别要记录分析的业务事件时，才需要这样做。例如，想跟踪每小时生产的平均订单数，以便与订单其他因素相关联来判断。

**改变状态的不重要事件**
如果您的主机服务没有这样做，请自己记录。例如，不要登录ASP.NET控制器动作被调用时，使用web服务器日志代替。

**重要的、不经常(少于每小时一次)定时计划事件**
保存这些记录可以方便地检查预期的处理是否正在发生。

**重要--频繁定时计划事件**
不要在"信息"级别记录频繁发生的事件，以免日志泛滥。可以考虑添加一条不太频繁的“心跳”消息。

#### 调试
代码路径在计算或条件分支方面非常复杂。添加足够的调试消息，以便您可以跟踪所发生的事情，而无需附加调试器。

### **避免** 记录敏感信息
确保您的日志记录器可以省略凭据和/或屏蔽敏感信息。例如，永远不要记录完整的信用卡号码，而是屏蔽除最后四位数字以外的所有号码。

### **要** 调优第三方包的日志级别
监视详细日志记录包的日志，并使用配置进行调优，以匹配应用程序代码的日志级别。

## 如何配置应用程序日志记录
### **要** 在已部署环境中设置适当的日志级别
非开发环境的典型默认级别是"信息"。更详细的日志记录应该只在有限的情况下使用，以隔离已知的问题。

### **考虑** 处理消息的总体接收成本
根据日志消息序列化(CPU)、网络消耗和延迟、消息反序列化(内存)、消息写入(例如索引)、消息读取和存储(磁盘成本)，了解所选接收器解决方案(例如云托管事务数据库)的成本。

### **要** 允许日志解决方案收集元数据
日志记录线程名、源文件名、方法名和其他消息元数据应该由日志库处理。避免添加影响CPU和I/O的调用来收集额外的日志输出。

### **要** 利用缓冲和节流来保护系统的性能
请注意，您的日志记录解决方案(和接收器)是否支持缓冲(在内部对消息进行排队并按块写入，如文件接收器)或节流(可以约束自己以防止中央存储过载的网络包转发器)并启用该特性。健壮的保护可以限制每个消息源和/或消息类型，并在查看的输出中指出在日志记录峰值期间保护是有效的。

## 日志级引导
[微软](https://docs.microsoft.com/en-us/aspnet/core/fundamentals/logging/?view=aspnetcore-2.2#log-level)
[Serilog](https://github.com/serilog/serilog/wiki/Configuration-Basics#minimum-level)

## 附录1:日志库选择标准
本节记录要在日志库中寻找的质量和功能。

**可配置的**
记录器是否可以在运行时配置为各种输出接收器?我们应该能够编码“log.Debug”，无论我们是保存到文件、数据库还是网络存储，都不必进行调整。

**性能卓越**
启用日志记录不会导致系统中明显的性能下降。

**独立运行**
应用程序不应该因为日志库遇到问题而遇到异常或错误。(例如正在写入的磁盘已满)

**很好维护**
最好是社区或商业支持的图书馆，而不是自己创建的。它应该积极地进行定期更新、稳定的开发，并拥有一个健康的集成生态系统、插件、与其他工具(如Microsoft公共日志记录、DI工具等)的扩展。

**支持结构化日志记录**
结构化日志与传统的基于文本的日志不同，它将消息捕获为一系列带有时间戳的名称/值属性，而不是字符串。传统的日志消息可能是:
“登录失败。尝试次数: 4”

结构化的日志消息可以在概念上可视化为:
时间: 2019-06-07 12:34
消息: “登录失败.”
属性:
	键:尝试次数
	值:4

因为事件的消息具有结构良好的值(“尝试次数”属性的值为“4”)，所以可以用关系操作符查询它们(例如，显示尝试次数大于3的所有失败的登录事件)。对于纯消息字符串，这通常不容易。